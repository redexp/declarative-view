!function(t){"function"==typeof define&&define.amd?define(["jquery"],t):"function"==typeof require&&"object"==typeof exports&&"object"==typeof module?module.exports=t(jQuery):window.DeclarativeView=t(jQuery)}(function(t){function e(){this.events={},this.listeners=[]}function n(e){n.parent.apply(this,arguments),e=e||{},this.id=n.nextId(),this.wrappers={sources:[],targets:[]},this.node=t(e.node||this.node||"<div>"),e.parent&&(this.parent=e.parent),this.data=P({object:this,prop:"data",deep:!1}),this.ui=P({object:this,prop:"ui",deep:!1}),this.template=P({object:this,prop:"template",deep:!0}),e.data&&A(this.data,e.data),e.ui&&A(this.ui,e.ui),e.template&&j(this.template,e.template);for(var r in this.ui)this.ui.hasOwnProperty(r)&&F(this,r);n.helpers.template(this,"",this.template)}function r(t,e,i){for(var o in i){if(!i.hasOwnProperty(o))return;var s=i[o];"&"===o.charAt(0)?o=o.slice(1):e&&(o=" "+o);for(var a in s)if(s.hasOwnProperty(a))if("&"!==a.charAt(0))n.helpers[a](t,e+o,s[a]);else{var f={};f[a]=s[a],r(t,e+o,f)}}}function i(t,e,n){g({view:t,node:t.find(e),method:"toggleClass",options:n,wrapper:function(t){return!!t}})}function o(t,e,n){g({view:t,node:t.find(e),method:"attr",options:n})}function s(t,e,n){g({view:t,node:t.find(e),method:"prop",options:n})}function a(t,e,n){g({view:t,node:t.find(e),method:"css",options:n})}function f(t,e,n){v({view:t,node:t.find(e),method:"html",options:n})}function c(t,e,n){v({view:t,node:t.find(e),method:"text",options:n,wrapper:function(t){return null===t||void 0===t?"":t}})}function h(t,e,n,r){function i(e){var n="!"===e.charAt(0);return n&&(e=e.slice(1)),function(r){n&&r.preventDefault(),e&&t[e].apply(t,arguments)}}var o=t.find(e);r=!!r;for(var s in n)if(n.hasOwnProperty(s)){var a=n[s];switch(typeof a){case"function":t.listenOn(o,s,a,r);break;case"object":for(var f in a)if(a.hasOwnProperty(f)){var c=a[f];"string"==typeof c&&(c=i(c)),t.listenOn(o,s,f,c,r)}break;case"string":t.listenOn(o,s,i(a),r)}}}function p(t,e,n){h(t,e,n,!0)}function u(t,e,n){function r(e,n){var r="change";e.indexOf("|")>-1&&(e=e.split("|"),r=e[1],e=e[0]),t.listenOn(i,r,function(){t.set(n,i.prop(e))}),t.on("@"+n,function(t){t!==i.prop(e)&&i.prop(e,t)})}var i=t.find(e);for(var o in n)n.hasOwnProperty(o)&&r(o,n[o])}function l(e,r,i){function o(t,r){var o,s;if(T(i.view))o=i.view;else if(i.view){var a=i.view.call(e,t,l.clone());T(a)?o=a:(s=a,s.parent=s.parent||e)}else o=n;if(o&&i.template&&(o=o.extend({template:i.template})),o&&(s=new o({node:l.clone(),parent:e,data:"object"!=typeof t?{value:t}:A({},t)})),s.context=t,p.add(s,r),i.add)return void i.add.call(e,c,s,r);0===r?1===p.length()?c.append(s.node):s.node.insertBefore(p.get(1).node):s.node.insertAfter(p.get(r-1).node)}function s(t,n){i.remove?i.remove.call(e,c,p.get(n),n):p.get(n).remove(),p.removeAt(n)}function a(t,n,r){if(p.moveFrom(r,n),i.move)return void i.move.call(e,c,p.get(n),n,r);var o=p.get(n).node;0===n?1===p.length()?o.appendTo(c):o.insertBefore(p.get(1).node):o.insertAfter(p.get(n-1).node)}function f(){if(i.sort)return void i.sort.call(e,c,p);h.forEach(function(t,e){var n=p.indexByContext(t);e!==n&&a(t,e,n)})}var c=e.find(r),h=e.model(i.prop),p=new x([]),u=!1===i.node?[]:i.node||"> *",l="string"==typeof u&&"<"!==u.charAt(0)?c.find(u):t(u);l.detach(),h.views=h.views||{},h.views[r]=p,e.listenOn(h,"add",o),e.listenOn(h,"remove",s),e.listenOn(h,"move",a),e.listenOn(h,"sort",f),h.forEach(o)}function v(t){function e(e,r){n.on(e,function(){t.value=r?r.apply(n,arguments):arguments[0],d(t)})}var n=t.view,r=t.options;switch(t=A({},t),typeof r){case"string":e(r);break;case"object":if(null===r)break;for(var i in r)r.hasOwnProperty(i)&&null!==r[i]&&e(i,r[i]);break;case"function":t.value=r.call(n),d(t);break;default:throw new Error("Unknown options type")}}function d(e){var n=e.view,r=e.node,i=e.method,o=e.firstArgument,s=e.value,a=e.wrapper;if("function"==typeof s){var f,c=s;a&&(c=function(t,e){return a(s.call(n,t,e))}),f=o?function(t,e){t[i](o,c.call(n,t,e))}:function(t,e){t[i](c.call(n,t,e))};for(var h=0,p=r.length;h<p;h++)f(t(r[h]),h)}else o?r[i](o,s):r[i](s)}function g(t){var e=t.options;for(var n in e)e.hasOwnProperty(n)&&(t.firstArgument=n,t.options=e[n],v(t))}function w(t){e.call(this),this.context=t}function y(t,e,n){w.call(this,n),this.view=t,this.path=e,this.on("set",function(t,e,n){var r=this.view.wrappers.sources.indexOf(n);-1!==r&&this.view.wrappers.targets[r].clear()})}function m(){w.apply(this,arguments)}function O(t,e,n){y.apply(this,arguments),this.on("remove",function(t){var e=this.view.wrappers.sources.indexOf(t);-1!==e&&this.view.wrappers.targets[e].clear()})}function x(){m.apply(this,arguments)}function b(t,e,n){if("function"==typeof this&&(n=arguments[0]||{},e=this,t=n.hasOwnProperty("constructor")?n.constructor:function(){e.apply(this,arguments)}),Object.create)t.prototype=Object.create(e.prototype);else{var r=function(){};r.prototype=n,t.prototype=new r}return t.prototype.constructor=t,A(t.prototype,n),t.extend=e.extend,t.parent=e,t.__super__=e.prototype,t}function A(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);return t}function j(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=t[n]&&e[n]&&"object"==typeof t[n]&&"object"==typeof e[n]?j(t[n],e[n]):e[n]);return t}function P(t){var e=Object.getPrototypeOf(t.object);if(e){var n=!t.list;if(n&&(t.context=t.object,t.list=[]),t.list.push(e[t.prop]),t.object=e,P(t),n){for(var r=t.list,i=t.deep?j:A,o={},s=r.length-1;s>=0;s--){var a=r[s];i(o,"function"==typeof a?a.call(t.context,i):t.deep?k(a):a)}return o}}}function k(t){var e={};for(var n in t)if(t.hasOwnProperty(n)){var r=t[n];e[n]=r&&"object"==typeof r?k(r):r}return e}function E(t,e){var n=t.indexOf(e);-1!==n&&t.splice(n,1)}function L(t,e){for(var n=0,r=t.length;n<r;n++)if(e(t[n],n))return t[n]}function B(t){return t[t.length-1]}function C(t){return"object"==typeof t?t:t.indexOf(" ")>-1?t.split(/\s+/):[t]}function I(t,e){return t.length>e?Array.prototype.slice.call(t,e):[]}function _(t){for(var e in t)if(t.hasOwnProperty(e))return!1;return!0}function F(e,n){var r=e.ui[n];if("string"==typeof r){if("<"===r.charAt(0))return e.ui[n]=t(r);var i="uiSelector"+e.id;r=r.replace(/@(\w+)/g,function(t,n){return F(e,n)[i]}),e.ui[n]=r?e.node.find(r):e.node,e.ui[n][i]=r}return e.ui[n]}function T(t){return"function"==typeof t&&"function"==typeof t.extend}function q(t,e){for(var n=t,r=0,i=e.length-1;r<i;r++)n=n.model(e[r]);return n}A(e,{extend:b}),A(e.prototype,{on:function(t,e,n,r){t=C(t),"boolean"==typeof n&&(r=n,n=null);var i=this;return t.forEach(function(t){if(t){var o,s=e,a=!1,f=!1,c=!1;if("!"===t.charAt(0)&&(a=!0,t=t.slice(1)),"="===t.charAt(0)?(f=!0,o=t.slice(1)):"@"===t.charAt(0)&&(c=!0,o=t.slice(1),t="set/"+o),(f||c)&&o.indexOf(".")>-1&&(o=o.split(".")),(a||o)&&(s=function(t){var r=o?i.get(o):t;a&&(r=!r);var s=[r];arguments.length>0&&(s=s.concat(I(arguments,o&&!a?1:0))),e.apply(n||i,s)}),(f||c)&&s(i.get(o)),!f){var h=i.events[t];h||(h=i.events[t]=[]),h.push({once:r,context:n,callback:e,wrapper:s}),o instanceof Array&&i.listenOn(q(i,o),"set/"+B(o),s)}}}),this},once:function(t,e,n){return this.on(t,e,n,!0)},off:function(t,e){if(0===arguments.length)return this.events={},this;t=C(t);for(var n=0,r=t.length;n<r;n++){var i=t[n],o=this.events[i];if(o)if(e){for(var s=0,a=o.length;s<a;s++)if(o[s].callback===e){o.splice(s,1);break}0===o.length&&delete this.events[i]}else delete this.events[i]}return this},trigger:function(t){var e=this.events[t];if(!e)return this;for(var n=I(arguments,1),r=0,i=e.length;r<i;r++){var o=e[r];o.once&&(e.splice(r,1),r--,i--),o.wrapper.apply(o.context||this,n)}return 0===e.length&&delete this.events[t],this},listenTo:function(t){var e=this,n=t.target,r=t.events,i=t.callback,o=t.once,s=L(this.listeners,function(t){return t.target===n});return s||(s={target:n,off:t.off,events:{}},this.listeners.push(s)),r=C(r),r.forEach(function(r){var a=s.events[r];a||(a=s.events[r]=[]);var f=function(){return o&&e.stopListening(n,r,i),i.apply(e,arguments)};a.push({origin:i,wrapper:f}),t.on(n,r,f)}),this},stopListening:function(t,e,n){var r;if(t&&!(r=L(this.listeners,function(e){return e.target===t})))return this;switch(e&&(e=C(e)),arguments.length){case 0:for(var i=this.listeners.length-1;i>-1;i--)this.stopListening(this.listeners[i].target);break;case 1:for(var o in r.events)r.events.hasOwnProperty(o)&&r.events[o].forEach(function(e){r.off(t,o,e.wrapper)});E(this.listeners,r);break;case 2:e.forEach(function(n){r.events.hasOwnProperty(n)&&(r.events[n].forEach(function(e){r.off(t,n,e.wrapper)}),delete r.events[e])});break;case 3:e.forEach(function(e){var i=r.events[e];i&&(i.forEach(function(o){o.origin===n&&(r.off(t,e,o.wrapper),E(i,o))}),0===i.length&&delete r.events[e])})}return r&&_(r.events)&&E(this.listeners,r),this},listenOn:function(t,e,n){var r=I(arguments,1),i=!1;return n=B(r),"boolean"==typeof n&&(i=n,r.pop(),n=B(r)),this.listenTo({target:t,events:e,callback:n,once:i,on:function(t,e,n){r[0]=e,r[r.length-1]=n,t.on.apply(t,r)},off:function(t,e,n){var r;r=n?[e,n]:e?[e]:[],t.off.apply(t,r)}})},listenOnce:function(t,e,n){var r=I(arguments,0);return r.push(!0),this.listenOn.apply(this,r)}}),A(n,{$:t,ObjectWrapper:w,ArrayWrapper:m,currentId:0,nextId:function(){return++this.currentId}}),b(n,e,{ui:{root:""},get:function(t){if(0===arguments.length)return this.data;if(t instanceof Array){for(var e=this,n=0,r=t.length-1;n<r;n++)e=e.model(t[n]);return e.get(t[r])}return this.data[t]},set:function(t,e){if(t instanceof Array){return q(this,t).set(B(t),e),this}if("object"==typeof t){for(var n in t)t.hasOwnProperty(n)&&this.set(n,t[n]);return this}var r=this.get(t);if(r===e)return this;var i=this.wrappers.sources.indexOf(r);return-1!==i&&this.wrappers.targets[i].clear(),this.data[t]=e,this.trigger("set/"+t,e,r),this.trigger("set",t,e,r),this},model:function(t){if(t instanceof Array){for(var e=this,n=0,r=t.length;n<r;n++)e=e.model(t[n]);return e}var i=this.get(t),o=this.wrappers.sources.indexOf(i);return-1===o&&(o=this.wrappers.sources.push(i)-1,this.wrappers.targets.push(this.wrapper(i,[t]))),this.wrappers.targets[o]},wrapper:function(t,e){return new(t instanceof Array?O:y)(this,e,t)},find:function(t){var e=t.indexOf("@");if(0===e){var n=t.slice(1);if(this.ui.hasOwnProperty(n))return this.ui[n]}if(e>-1){var r=this,i="uiSelector"+r.id;t=t.replace(/@(\w+)/,function(t,e){return F(r,e)[i]})}return t?this.node.find(t):this.node},remove:function(){return this.stopListening(),this.off(),this.node.remove(),this}}),n.helpers={template:r,class:i,toggleClass:i,attr:o,prop:s,style:a,css:a,html:f,text:c,on:h,once:p,connect:u,each:l},b(w,e,{get:function(t){return 0===arguments.length?this.context:this.context[t]},set:function(t,e){if("object"==typeof t){for(var n in t)t.hasOwnProperty(n)&&this.set(n,t[n]);return this}var r=this.get(t);return r===e?this:(this.context[t]=e,this.trigger("set/"+t,e,r),this.trigger("set",t,e,r),this)}});var D={model:function(t){var e=this.get(t),n=this.view.wrappers.sources.indexOf(e);return-1===n&&(n=this.view.wrappers.sources.push(e)-1,this.view.wrappers.targets.push(this.view.wrapper(e,this.path.concat(t)))),this.view.wrappers.targets[n]},clear:function(){var t=this.view.wrappers.sources.indexOf(this.context);if(-1!==t){var e=this.view.wrappers.targets[t];this.view.stopListening(e),this.view.wrappers.sources.splice(t,1),this.view.wrappers.targets.splice(t,1)}var n=this.get();for(var r in n)n.hasOwnProperty(r)&&-1!==(t=this.view.wrappers.sources.indexOf(n[r]))&&this.view.wrappers.targets[t].clear();this.view=this.path=this.context=null}};return b(y,w,D),b(m,w,{indexOf:function(t){return this.context.indexOf(t)},forEach:function(t){return this.context.forEach(t),this},length:function(){return this.context.length},add:function(t,e){t instanceof Array==!1&&(t=[t]);var n=this.context;void 0===e&&(e=n.length);for(var r=0,i=t.length;r<i;r++){var o=t[r],s=e+r;n.length<=s?n.push(o):n.splice(s,0,o),this.trigger("add",o,s)}return this},remove:function(t){if(t instanceof Array){for(var e=0,n=t.length;e<n;e++)this.remove(t[e]);return this}return this.removeAt(this.indexOf(t)),this},removeAt:function(t){if(t instanceof Array){t=1===t.length?t:[].concat(t).sort(function(t,e){return e-t});for(var e=0,n=t.length;e<n;e++)this.removeAt(t[e]);return this}var r=this.context;if(!r.hasOwnProperty(t))return this;var i=r[t];return t+1===r.length?r.pop():0===t?r.shift():r.splice(t,1),this.trigger("remove",i,t),this},removeAll:function(){for(var t=this.length()-1;t>-1;t--)this.removeAt(t);return this},replace:function(t,e){return this.replaceAt(this.indexOf(t),e)},replaceAt:function(t,e){return this.removeAt(t),this.add(e,t),this},move:function(t,e){return this.moveFrom(this.indexOf(t),e)},moveFrom:function(t,e){if(t===e)return this;var n=this.get(t);return this.context.splice(t,1),this.context.splice(e,0,n),this.trigger("move",n,e,t),this},sort:function(t){return this.context.sort(t),this.trigger("sort"),this}}),b(O,m,D),b(x,m,{indexByContext:function(t){for(var e=this.context,n=0,r=e.length;n<r;n++)if(e[n].context===t)return n}}),n});